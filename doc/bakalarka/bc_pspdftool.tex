%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%                                    %%%
%%% Bakaláøské práce na MFF UK         %%%
%%%                                    %%%
%%% (c) Ale¹ ©nupárek, 2007            %%%
%%%                                    %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt,notitlepage]{report}
%\pagestyle{headings}
\pagestyle{plain}

\frenchspacing % aktivuje pou¾ití nìkterých èeských typografických pravidel

\usepackage[latin2]{inputenc} % nastavuje pou¾ité kódování, u¾ivatelé Windows zamìní latin2 za cp1250
\usepackage[czech]{babel}
\usepackage{a4} % nastavuje standardní evropský formát stránek A4
\usepackage{index} % nutno pou¾ít v~pøípadì tvorby rejstøíku balíèkem makeindex
%\usepackage{fancybox} % umo¾òuje pokroèilé rámeèkování :-)
\usepackage{graphicx} % nezbytné pro standardní vkládání obrázkù do dokumentu
\usepackage{longtable}


%\usepackage[left=3cm]{geometry} % nastavení dané velikosti okrajù
%\usepackage[total={145mm,247mm}]{geometry}
\usepackage[total={17cm,25cm}, top=3cm, left=2cm, includefoot]{geometry}

\newcommand\uv[1]{\quotedblbase #1\textquotedblleft}

%\newindex{default}{idx}{ind}{Rejstøík} % zavádí rejstøík v~pøípadì pou¾ití balíku index

\title{Pøedtisková pøíprava dokumentù}   % tyto dvì polo¾ky jsou zde v~podstatì formálnì, ve skuteènosti nejsou nikde 
\author{Ale¹ ©nupárek} % dále v~dokumentu pou¾ity

%\date{}

\begin{document}

%\csprimeson % zapne jednoduché psaní èeských uvozovek pomocí klasických znakù, ale potom pozor 
		     % na originální apostrofy, které budou chybnì interpretovány!!!

%%% Následuje první, úvodní, strana bakaláøské práce. Jednotlivé polo¾ky nahraïte dle vlastních
%%% údajù. Zmìnit podle konkrétní délky jednotlivých polo¾ek mù¾ete i~zalomení øádkù.
\begin{titlepage}
\begin{center}
\ \\

\vspace{15mm}

\large
Univerzita Karlova v~Praze\\
Matematicko-fyzikální fakulta\\

\vspace{5mm}

{\Large\bf BAKALÁØSKÁ PRÁCE}

\vspace{10mm}

%%% Aby vlo¾ní loga v¹e správnì fungovalo, je tøeba mít soubor logo.eps nahraný v~pracovním adresáøi,
%%% tj. v~adresáøi, kde se nachází pøekládaný zdrojový soubor. Soubor logo.eps je mo¾né získat napø.
%%% na adrese: http://www.mff.cuni.cz/fakulta/symboly/logo.eps
\includegraphics[scale=0.3]{logo.eps} 

\vspace{15mm}

%\normalsize
{\Large Ale¹ ©nupárek}\\ % doplòte va¹e jméno
\vspace{5mm}
{\Large\bf Pøedtisková pøíprava dokumentù}\\ % doplòte název práce
\vspace{5mm}
Katedra aplikované matematiky\\ % doplòte název katedry èi ústavu
\end{center}
\vspace{15mm}

\begin{center}
\large
\noindent Vedoucí bakaláøské práce: Mgr. Martin Mare¹ % doplòte odpovídající údaje
\vspace{1mm} 

\noindent Studijní program: Informatika % doplòte odpovídající údaje
%%% dal¹í øádek mù¾ete ve vìt¹inì pøípadù (tj. pokud údaje uvedené vý¹e nejsou pøíli¹ dlouhé) zru¹it

\end{center}

\vspace{20mm}

\begin{center}
2007 % doplòte rok vzniku va¹í bakaláøské práce
\end{center}

\end{titlepage} % zde konèí úvodní strana

\normalsize % nastavení normální velikosti fontu
\setcounter{page}{2} % nastavení èíslování stránek
\ \vspace{10mm} 

\noindent Na tomto místì bych chtìl podìkovat lidem, bez jejich¾ pomoci by nikdy tato práce 
nevznikla. Mé díky patøí zejména Mgr. Martinu Mare¹ovi za vedení bakaláøské práce, za dobré rady 
a vìcné pøipomínky. 

\vspace{\fill} % nastavuje dynamické umístìní následujícího textu do spodní èásti stránky
\noindent Prohla¹uji, ¾e jsem svou bakaláøskou práci napsal samostatnì a výhradnì s~pou¾itím citovaných pramenù. Souhlasím se zapùjèováním práce a jejím zveøejòováním.

\bigskip
\noindent V~Praze dne \today{} \hspace{\fill}Ale¹ ©nupárek\\ % doplòte patøièné datum, jméno a pøíjmení

%%%   Výtisk pak na tomto míste nezapomeòte PODEPSAT!
%%%                                         *********

\tableofcontents % vkládá automaticky generovaný obsah dokumentu

\newpage % pøechod na novou stránku

%%% Následuje strana s~abstrakty. Doplòte vlastní údaje.
\noindent
Název práce: Pøedtisková pøíprava dokumentù\\
Autor: Ale¹ ©nupárek\\
Katedra (ústav): Katedra aplikované matematiky\\
Vedoucí bakaláøské práce: Mgr. Martin Mare¹\\
e-mail vedoucího: mares@kam.mff.cuni.cz\\

\noindent Abstrakt:  V~pøedlo¾ené práci se zabývám nìkterými tiskovými formáty (PDF, PostScript), 
mo¾ností úprav hotových dokumentù pøed samotným tiskem.
Dále zkoumám souèasné nástroje pro dané úpravy. V~èásti se zabývám návrhem a realizací nástroje,
který umo¾òuje provádìt nìkteré ze základních pøedtiskových úprav.\\

\noindent Klíèová slova: PostScript, PDF, tisk

\vspace{10mm}

\noindent
Title: Preprinting preparation of documents\\
Author: Ale¹ ©nupárek\\
Department: Department of Applied Mathematics\\
Supervisor: Mgr. Martin Mare¹\\
Supervisor's e-mail address: mares@kam.mff.cuni.cz\\

\noindent Abstract: In the present work I study printing formats (PDF, PostScript) 
and abilities of modifiing finished documents before printing.
In the other part of my work I scope todays tool for preprinting preparations of documents.
In the last part of my work is design and implementation of my tool for some of base of preprinting preparations of documents.\\

\noindent Keywords: PostScript, PDF, printing

\newpage

%%% Následuje text bakaláøské práce èlenìný do kapitol, které se èíslují, oznaèí názvy a graficky oddìlí.
%%% Nedoporuèuje se pou¾ívat víc ne¾ dvì úrovnì èíslování kapitol, viz pøíklad ní¾e.

\chapter{Úvod}
V~této práci \uv{Pøedtisková pøíprava dokumentù} zkoumám mo¾nosti úprav dokumentù v~tisko\-vém formátu. Nezabývám se nástroji pro
tvorbu tìchto dokumentù, ani nezkoumám rùzné tiskové metody. Zabývám se pouze dokumenty v~tiskovém formátu a to konkrétnì v~PostScriptu a v~PDF.

Práce je rozdìlena do nìkolika èástí. První èást vysvìtluje základní pojmy, které se týkají dokumentù a pøedtiskových úprav.
Druhá èást popisuje jak fungují formáty PostScript a PDF s~ohledem na jejich pøedtiskové úpravy.
V~tøetí èásti je popis nìkterých souèasných nástrojù pro pøedtiskové úpravy dokumentù.
Poslední èást se zabývá mnou vytvoøeným nástrojem pspdftool, který umí provádìt rùzné pøedtiskové úpravy ve formátech PostScript a PDF.
Pøíkladem tìchto úprav mù¾e být: zmìna rozmìrù stránky, selekce a pøeuspoøádání stránek nebo umístìní více stránek na jeden arch papíru.

\chapter {Dokumenty a práce s~nimi}

\section {Dokument}
Pod pojmem dokument si pøedstavme soubor na pamì»ovém médiu uchovávající nìjakou informaci. 
Na dokument urèený primárnì pro tisk klademe následující po¾adavky: 
musí definovat jednotlivé stránky, definovat jejich obsah a uchovávat jejich atributy.


\section {Stránka}
Stránka je soubor objektù, které se vytisknou na jeden arch papíru.
Objektem mù¾e být text, èára, køivka, bitmapa, nebo jiný grafický útvar.

Pro umístìní objektu na stránce je potøeba definovat souøadnicový systém. 
Zpravidla se pou¾ívá kartézský souøadnicový systém, který má poèátek v~levém dolním rohu stránky. 
Jeho x-ová souøadnice je orientovaná vodorovnì, zleva doprava, y-ová souøadnice je orientovaná svisle, smìrem zdola nahoru. 
Základní jednotkou tohoto systému mù¾e být tiskaøský bod.\footnote{1 bod obvykle odpovídá 1/72 palce}

Mezi atributy popisující konkrétní stránku patøí: velikost papíru, orientace textu a bounding box (bbox).
Bounding box urèuje nejmen¹í obdélníkovou oblast, do které se vykreslí v¹echny objekty z~pøíslu¹né stránky.

\section {Formáty dokumentù}
Formát dokumentu urèuje,  jaké informace a jakým zpùsobem budou reprezentovány v~souboru.
Pro vytvoøení a úpravu dokumentu se pou¾ívá editor. Pokud lze dokument vytisknout, obsahuje pøíslu¹ný editor funkci,
která vygeneruje ze vstupního souboru  výstup do vhodného formátu pro tisk.
Dle tohoto hlediska mù¾eme rozdìlit formáty na následující dva druhy: formáty editorù a formáty urèené k~tisku.

Formát z editoru nemusí obsahovat dostateèné informace pro výsledný tisk.
U~bitmapových formátù èasto chybí údaj na jaký rozmìr papíru a jak se konkrétnì vytisknou.
Jeho dal¹ím nedostatkem je pøípadná závislost na konkrétním prostøedí. Napøíklad pro korektní zobrazení dokumentu z~OpenOffice potøebujeme
mít nainstalované konkrétní øezy písma.

Formáty pro tisk, na rozdíl od formátù editorových, nejsou urèeny k~dal¹í editaci, av¹ak nìkteré operace lze s~nimi také, jak uká¾eme dále, provádìt.
Tisknutelným formátem mù¾e být jazyk urèený pøímo pro tiskárnu (PostScript, PCL, GDI, HPGL), nebo formát, z~kterého je mo¾no pøímo tisknout (PDF).
Pøevod dokumentu na jazyk pro tiskárnu mù¾e mít jistá omezení, napøíklad  závislost na konkrétním typu a rozli¹ení tiskárny. 
Dále se budu zabývat formáty PostScript a PDF.


\section {Pøedtiskové úpravy}

Pøedtiskové úpravy se týkají formátù explicitnì urèených pro tisk. 
Patøí mezi nì pøeskupení, otoèení, selekce, zmìna formátu papíru, zvìt¹ení èi zmen¹ení stránek,
ale netýkají se: zmìny  obsahu, stylu odstavce nebo jiný zásah do struktury stránky.

Dùvodem pro pøedtiskové úpravy mù¾e být absence dané úpravy v~aplikaci, ve které dokument vznikl, nebo absence podkladù, 
ze kterých vznikl dokument v~tisknutelném formátu. Pøíkladem mohou být dokumenty od tøetí strany, jako jsou rùzné dokumentace.

Nìkteré ovladaèe tiskáren umo¾òují provést nìkteré z~tìchto úprav, ale obecnì se jedná o~proprietární roz¹íøení konkrétního dodavatele ovladaèe.
Proto je vhodné mít mo¾nost tyto úpravy provést pomocí nìjakého nezávislého nástroje.

\chapter{Vybrané formáty}
V~této kapitole popí¹i formáty PostScript a PDF.
Tyto formáty jsem si zvolil, proto¾e jsou èasto pou¾ívané, existuje k~nim volnì  dostupná dokumentace,
jsou vhodné pro tisk a je  na nich mo¾né realizovat nìkteré z~pøedtiskových úpravy.

\section{Grafický meta-formát PostScript}
PostScript \cite{postscript} je programovací jazyk navr¾ený firmou Adobe.  Je primárnì urèen pro tisk dokumentù na laserových tiskárnách, 
ale mù¾e být pou¾it pro popis grafiky i~na jiném zaøízení (napøíklad obrazovce poèítaèe). 
Pro jeho zobrazení mù¾eme pou¾ít GhostScript \cite{ghostscript}.

PostScript je turingovsky úplný programovací jazyk s~prefixovou notací.
Je podobný svou syntaxí jazyku Forth, ale na rozdíl od nìj je specializovaný pro popis grafického výstupu na stránku.
Mezi základní elementy jazyka PostScript  patøí: oblouk, B\`ezierova køivka a úseèka. Pro písmo existují speciální pøíkazy, které vykreslí písmena z~køivek. Tyto elementy nejsou závislé na rozli¹ení výstupního zaøízení.

PostScriptový interpret vyu¾ívá nìkolik zásobníkù. Mezi nejdùle¾itìj¹í patøí zásobník na operandy pøíkazù a zásobník pro ulo¾ení slovníkù.
Slovník je kolekce párù klíè a hodnota. Pøidáním nového záznamu do slovníku lze definovat pojmenované konstanty nebo nové pøíkazy,
pøípadnì pøedefinovat stávající pøíkazy.

PostScript pracuje s~dvìma souøadnicovými systémy: device space a user space. Device space je souøadnicový systém cílového výstupního zaøízení.
User space je souøadnicový  systém, ve kterém se zadává poloha objektù (napøíklad èar).
Poèátek tohoto systému je v levém dolním rohu.  X-ová osa je orientována zleva do pravá a y-ová osa vede zdola nahoru.
Vzdálenost dvou bodù (tiskaøských bodù) v~tomto systému je 1/72 palce. 
Pøevod mezi user space a device space je realizován pomocí transformaèní matice, která reprezentuje afinní transformaci.

Cesta je kolekce èar a køivek umístìných na stránce, ale neobsahuje informaci o~tom, jakým zpùsobem bude vykreslena.
Aktuální cesta je právì rozkreslená cesta. Cesta mù¾e definovat oøez, tj. oblast, za kterou se nebude vykreslovat, nebo
být køivkou urèité ¹íøky a barvy.

Graphics State jsou rùzná nastavení popisující stav grafického systému. Mezi nì patøí: aktuální cesta, aktuální oøezová cesta,
aktuální font, aktuální transformaèní matice, barva, typ vykreslované èáry.
Tento stav je mo¾né ulo¾it, respektive obnovit, pomocí operátorù {\it gsave} a {\it grestore}.

\section{Afinní transformace}
Afinní transformace se aplikuje na jednotlivé grafické objekty. Touto transformací lze popsat v¹echny bì¾né transformace,
jako je posunutí, otoèení nebo  zmìna velikosti. Lze jí reprezentovat pomocí transformaèní maticí $3\times3$. Tuto reprezentaci pou¾ívá 
PostScript a PDF. V~pøípadì bodu se souøadnicemi $[x,y]$ vypadá následovnì.
$$[x',  y',  1] = [x, y, 1]  \times
\pmatrix{
a & b & 0 \cr
c & d & 0 \cr
e & f & 1 \cr
}$$
Jednotlivé transformace jsou uzavøené na skládání a v~pøípadì maticové reprezentace se jedná o~násobení matic.


\section{DSC komentáøe}
PostScript nedefinuje  ¾ádnou strukturu dokumentu, nelze tedy bez jeho interpretace rozpoznat jednotlivé stránky.
Tento problém vyøe¹ila firma Adobe zavedením speciálních komentáøù DSC (document structure comment) \cite{dsc} . 
Komentáø v~PS souboru zaèíná znakem {\tt \%} a konèí koncem øádky. DSC komentáø zaèíná na zaèátku øádky znaky   {\tt \%\%}. 
Díky tìmto komentáøùm lze rozdìlit dokument na následující èásti:  prolog a script.

Do prologu patøí header section, defaults section a procedure section. Èást Script mù¾eme rozdìlit na èást document setup, samostatné stránky a trailer.

Na zaèátku souboru s~DSC komentáøi je øádek urèující verzi DSC, souèasná verze je 3.0. Po této øádce následuje vý¹e zmínìná hlavièka, jedná se o~souvislou oblast komentáøù (neobsahuje pøíkazy pro PS interpret).
Hlavièka konèí komentáøem {\tt \%\%EndComments},
nebo prázdným øádkem. V~hlavièce jsou uvedeny základní informace o~dokumentu, jako jsou: 
poèet stránek {\tt \%\%Pages: poèet stránek {\tt |}  (atend)}, orientace textu na stránce {\tt \%\%Orientation: Portrait {\tt |}  Landscape}, 
bounding box, poøadí stránek v~dokumentu {\tt \%\%PageOrder: Ascend {\tt |}  Descend {\tt |}  Special {\tt |}  (atend)}.
Symbol {\tt (atend)} místo konkrétní hodnoty bude nahrazen hodnotou patøièné vlastnosti z~traileru na konci souboru.
%Pokud je hodnota parametru rovna {\tt (atend)} znamená, ¾e hodnota pøíslu¹né vlastnosti bude uvedena na konci souboru v~traileru.

Defaults section je nepovinná èást PS dokumentu, která  je slo¾ena pouze z~DSC komentáøù. Obsahuje doplòující informace o~dokumentu, 
urèené pro správce tisku.

Procedure section (procdef) mù¾e obsahovat  definice funkcí, které bude dále program pou¾ívat.
Toto místo je vhodné pro pøidání vlastních definicí (napøíklad nových operátorù).

 V~sekci  document setup mù¾e být postscriptový kód pro nastavení tiskárny (velikost papíru, nahrání fontù).
Po ní následují jednotlivé stránky.

 Zaèátek stránky, oznaèuje komentáø {\tt \%\%Page: jméno\_stránky  její\_èíslo}. Pøi tisku by nemìly být stránky závislé na poøadí, v~jakém jsou uvedeny v~souboru.
 Samotnou stránku lze obdobnì jako celý dokument rozdìlit na nìkolik èásti: Page Setup, obsah stránky, PageTrailer. Toto dìlení je nepovinné a vìt¹ina programù
 generujících PostScript ho nepou¾ívá.
U~ka¾dé stránky lze za pomoci DSC explicitnì vyjádøit rozmìr papíru, orientaci textu a bounding box.

Po v¹ech stránkách následuje Trailer. Mù¾e obsahovat kód pro uvedení PS interpretu do výchozího stavu pøed tiskem a mù¾e obsahovat podobné informace, jako obsahuje hlavièka.
 Soubor je zakonèen øádkem {\tt \%\%EOF}.

\subsubsection*{Pøíklad souboru s~DSC komentáøem:}

\begin{verbatim}
%!PS-Adobe-3.0
%%Creator: dvips(k) 5.78 Copyright 1998 Radical Eye Software ...
%%Title: popisky.dvi
%%Pages: 1
%%PageOrder: Ascend
%%BoundingBox: 0 0 936 86
%%DocumentFonts: CenturyExpdCEBTBoldItalic CenturyExpdCEBTItalic
%%EndComments
%DVIPSCommandLine: dvips -Plino1200 -D1800 -tfilm1 popisky
%DVIPSParameters: dpi=1800, compressed
%DVIPSSource:  TeX output 2001.09.24:2244
... Zde se nacházejí definièní hlavièky ...
%%EndProlog
%%BeginSetup
... Zde se nacházejí nastavovací hlavièky ...
%%EndSetup
%%Page: 1 1
... Zde se nachází popis stránky 1 ...
%%Trailer
... Zde se nachází ukonèovací sekvence ...
%%EOF
\end{verbatim}

Jazyk PostScript a jeho DSC komentáøe jsou obsáhlej¹í, ne¾ jsem uvedl v~této èásti, podrobnìj¹í informace jsou uvedeny ve specifikaci PostScriptu a DSC komentáøù.

\section{Portable Document Format}
Portable Document Format (PDF) \cite{pdf} byl vyvinut firmou Adobe. Jeho hlavní výhodou je zachování vìrnosti dokumentu pøi pøenosu souboru z~jednoho poèítaèe na druhý.
Vzhledem k~tomu, ¾e nìkteré èásti PDF mohou být komprimovány, je také vhodný pro pøenos dokumentù pøes sí» Internet.
Formát umo¾òuje nastavit nìkteré bezpeènostní atributy dokumentu, jako jsou: povolení tisku, povolení kopírováni z~dokumentu, povolení zmìn v~dokumentu a digitální podpis.

PDF definuje následující základní objekty: boolean, celoèíselný a reálný typ, øetìzec, jméno, pole, slovník, stream a nulový objekt.
Objekt typu Boolean mù¾e nabývat hodnot true a false. Èíselný typ je posloupnost èísel. Reálný typ jsou dvì èísla oddìlená desetinnou teèkou. 
Øetìzce mohou být lexikální nebo hexadecimální. Jméno je posloupnost znakù zaèínající lomítkem. Pole na rozdíl od jazyku~C mù¾e obsahovat prvky rùzného typu.
Slovník je seznam dvojic. První prvek z~dvojice je jméno a druhý je hodnota. Null objekt reprezentuje prázdný objekt.

Stream je objekt pro uschování libovolné posloupnosti bajtù. Je slo¾en ze slovníku, po kterém následuje samotný bitový stream, který je uvozen identifikátory {\it stream} a {\it endstream}.
Slovník streamu musí obsahovat povinný atribut {\it Length}, který udává délku bitového streamu. Nepovinný atribut {\it Filter} udává zpùsob, jakym je zakódovaný bitový stream.
Uvnitø streamu nemù¾e být odkaz na ostatní objekty v~dokumentu.

V~PDF je definován nepøímý objekt (indirect object). Nepøímým objektem mù¾e být libovolný objekt. Pro jeho jednoznaènou identifikaci jsou pou¾ita dvì èísla: první urèuje objekt,
druhé urèuje jeho revizi, novìj¹í verze objektu má vy¹¹í èíslo.
Syntakticky nepøímý objekt vypadá následovnì: {\it èíslo revize popis\_samotného\_objektu endobj }.
Na tento objekt se lze odkázat pomocí následující syntaxe, {\it èíslo\_objektu revize R}. 

Celý soubor je slo¾en z~nepøímých objektù. Pro rychlej¹í pøístup k~tìmto objektùm je v~souboru ulo¾ena tabulka (cross reference table).
Obsahuje pro ka¾dý nepøímý objekt v~souboru následující záznam: jeho minor number a offset od zaèátku souboru, kde se objekt nachází.
Díky této tabulce není potøeba pro pøístup ke konkrétnímu objektu celý soubor sekvenènì pøeèíst.
Pozice v souboru, na které se tabulka nachází, je uvedena na následující øádce za identifikátorem startxref. Tento identifikátor následuje za trailerem.
 
Na konci souboru je sekce trailer. Jedná se o~slovník, ve kterém je odkaz na catalog objekt. Pokud byl dokument inkrementálnì aktualizován, nachází se v~traileru odkaz na pøedchozí trailer. 
V~catalogu je uveden odkaz na strom stránek, pøípadnì informace o~zabezpeèení souboru a jiné globálnì platné informace pro dokument.

Strom stránek je tvoøen ze~dvou typù objektu: uzlù (Pages, odkazy na dal¹í stránky, mohou obsahovat nìkteré spoleèné informace pro stránky v~podstromì) a listù (samotné stránky).
Objektem stránky je slovník. Obsahuje odkaz na {\it Content Stream}, popisuje vzhled stránky, resources, pøes které se {\it Content Stream} stránky odkazuje na objekty v~dokumentu (napø. typ fontu), rozmìry papíru (MediaBox) a rozmìr bounding boxu (TrimBox).

Mezi èasto se vyskytující objekt v PDF patøí XObject. Jedná se o stream, struktura jeho slovníku je velmi podobná struktuøe slovníku popisujícího stránku.  Pou¾ívá se pro popis nìjakého grafického elementu.
Pøíkladem jeho pou¾ití mù¾e být vlo¾ení loga na stránku, které je popsáno XObjectem.

Stream pro popis obsahu stránky nebo XObjectu je syntakticky podobný jazyku PostScript, tj. prefixovou notací, pouze operátory  mají jiné názvy a nelze je pøedefinovat.
Z~grafických operátorù existují køivky, èáry, n-úhelníky, oøezové cesty a transformaèní matice.		

Inkrementální update je zpùsob aktualizace, kdy se na konec dokumentu pøidají novì aktualizované objekty, nová tabulka referencí a trailer. 
Pøi této aktualizaci není potøeba pøepisovat celý dokument.

Pro podrobnìj¹í specifikaci PDF doporuèuji nahlédnout Adobe PDF reference Manual.


\chapter{Souèasné programy}
Ve své práci jsem se zamìøil pøevá¾nì na programy PSUtils a pdftk, a to z dùvodu jejich dostupnosti. Jsem si vìdom, ¾e existují následující programy: FinePrint, Acrobat, ale vzhledem k~jejich dostupnosti (licence) jsem se zamìøil na ji¾ zmínìné dva. 
\section{PSUtils}
PSUtils \cite{psutils} jsou sadou nástrojù pro práci s~PostScriptovými dokumenty. Mezi tyto programy patøí: psnup (uspoøádání více stránek na jednu), psselect (výbìr jednotlivých stránek z~dokumentu), pstops (nástroj pro libovolné transformace), psbook (tvorba tiskových signatur pro tisk bookletù) a psresize (zmìna rozmìrù stránek). PSUtils jsou napsány v~jazyce~C a obsahují nìkolik skriptù napsaných v~perlu.

PSUtils umí vìt¹inu z~vý¹e zmínìných pøedtiskových operací. Nástroj pstops umí kombinovat násldedující základní operace: zmìnu velikosti stránky, rotaci stránky o~násobky 90 stupòù, posunutí stránky a spojení dvou stránek.
Umí spojit nìkolik dokumentù do jednoho, ale pouze takové, které mají stejný prolog.
Nelze v¹ak s~ním provédst následující operace: zrcadlení stránek, kreslení èi psaní textu na stránku.

\section{Pdftk}
Jedná se o~nástroj \cite{pdftk} napsaný v~jazyce Java. Tímto programem je mo¾né provádìt následující operace: spojení dvou dokumentù do jednoho,
výbìr stránek z~dokumentu, dekryptovat PDF, enkryptovat PDF, pøedvyplnìní formuláøù, opravit po¹kozené
PDF a dal¹í specifické úkony pro PDF formát. PDFTk umo¾òuje provádìt úkony, které nepatøí mezi pøedtiskové úpravy.
Souèasným nedostatkem tohoto programu jsou: neschopnost uspoøádání více stránek na jeden arch papíru a neschopnost doplnìní textu na stránku.

\chapter{Pspdftool}
Vý¹e zmínìné nástroje pro pøedtiskovou úpravu dokumentù se vzájemnì li¹í ve svém u¾ivatel\-ském rozhraní. Proto jsem se rozhodl vytvoøit univerzální nástroj,
který bude schopen pracovat se stejným rozhraním a rùznými formáty. Bude také schopen provádìt operace, které souèasná øe¹ení neobsahují.
Nástroj jsem navrhl s~ohledem na mo¾nost jeho roz¹íøení o~dal¹í formáty.
\section {U¾ivatelská pøíruèka}
Program pspdftool je konzolová aplikace, která se spou¹tí z~pøíkazové  øádky.
Programu je potøeba pøedat jako argument pøíkazy, nebo soubor s pøíkazy, které
bude program aplikovat na vstupní soubory, které následují za pøíkazy. Posledním
argumentem je výstupní soubor. Pokud je uvedeno více vstupních souborù, nejprve 
jsou spojeny do jednoho, tedy pokud to daný formát umo¾òuje.
Pokud jsou argumenty reprezentující vstupní a
výstupní soubory vynechány, program naète soubor ze standardního vstupu a výsledný
soubor vypí¹e na standardní výstup.
Ze vstupního souboru je vytvoøen seznam stránek.
Souèasnì podporované formáty jsou PostScript a PDF.

Vstupem ka¾dého pøíkazu je seznam stránek, na který se aplikuje pøíslu¹ná
operace. Jeho výstupem je upravený seznam stránek. Pøíkazy se vykonávají 
zleva doprava. První pøíkaz zpracuje seznam ze vstupních souborù a pøedá ho
následujícímu pøíkazu. Z~výsledného seznamu posledního pøíkazu je vytvoøen
výstupní soubor. Jednotlivé pøíkazy se mezi sebou oddìlují bílými znaky
\footnote{bílým znakem chápeme: mezeru, tabulátor, novou øádku}.
\begin{center}
{\tt vstupní\_seznam\_stránek \(\rightarrow\) pøíkaz \(\rightarrow\) výstupní\_seznam\_stránek }
\end{center}

\subsubsection*{Pøíklady:}
\small{
\begin{tabular}{lp{8 cm}}
{\tt pspdftool "nup(2, paper=a4)" in.pdf out.pdf}  & naète soubor in.pdf aplikuje na seznam stránek pøíkaz nup a výsledek ulo¾í do souboru out.pdf (uvozovky kolem pøíkazu jsou kvùli shellu)\\
{\tt pspdftool -f cmds.txt in.pdf out.pdf } & na rozdíl od pøedchozího se budou èíst pøíkazy ze souboru mycmds.txt\\
\end{tabular}
}
\vspace{5mm}

\subsubsection*{Ú¾iteèné pøikazy:}
\small{
\begin{tabular}{lp{8 cm}}
{\tt select\{1..5\}}  & vybere se prvních pìt stránek ze seznamu\\
{\tt scaleto(a4)} & pøizpùsobí velikosti stránky na papír velikosti a4\\
{\tt nup(2)}&vyrovnání dvou stránek na jednu\\
{\tt book}& pøerovnání stránek pro tisk bookletu\\
{\tt apply\{-1 del\}}& smazání pospední stránky v seznamu
\end{tabular}
}
\vspace{5mm}


Pøíkaz se skládá ze tøí èástí: názvu, jeho parametrù a selektoru stránek.
Název je posloupnost znakù identifikující typ pøíkazu.  

Sekce parametru pøíkazu zaèíná levou a konèí pravou kulatou závorkou.
Parametry mohou být
následujících typu: celoèíselného, desetinného, rozmìru, øetìzce, nebo
identifikátoru. Celoèíselný typ je posloupnost èísel. Desetinný typ obsahuje
celoèíselnou a desetinnou èást. Obì èásti jsou reprezentované celoèíselným typem
a jsou od sebe oddìleny desetinnou teèkou.
Rozmìr obsahuje desetinný typ a identifikátor, jednotku. Jednotkou mù¾e být:
mm, cm, pt a in. Implicitnì se pracuje s tiskaøským bodem. Øetìzec je
posloupnost znakù mezi uvozovkami. Identifikátor je posloupnost písmen.

Jednotlivé parametry pøíkazu jsou mezi sebou oddìleny èárkou.
Parametry pøíkazu je mo¾né zadávat poziènì, nebo je explicitnì pojmenovat.
Pozièní parametry musí v¾dy být pøed pojmenovanými.

Nìkteré parametry mohou mít uvedenou výchozí hodnotu. Potom není nutné
tento argument explicitnì uvádìt.

\subsubsection*{Pøíklady:}

\begin{tabular}{lp{10 cm}}
	{\tt foo}    &    pøíkaz bez parametru\\
	{\tt foo(a=1)} &  pøíkaz {\tt foo}, kterému je je nastaven parametr {\it a} na 1\\
	{\tt foo(1)} & pøíkaz {\tt foo}, kterému je první parametr nastaven na 1\\
	{\tt foo(a=1, 1)}& pojmenovaný argument pøed pozièním, chybnì \\
\end{tabular}

\vspace{5mm}

Poslední èástí je selektor stránek, zaèíná levou a konèí pravou slo¾enou
závorkou. Selektor je skupina výbìrù stránek, které jsou mezi sebou oddìleny 
mezerami.
Výbìr stránek mù¾e být èíslo, pøípadnì interval. Pokud výbìr zaèíná '-', jedna 
se o~výbìr z~konce seznamu, bì¾nì se indexuje od zaèátku. Za výbìrem mù¾e 
následovat seznam pøíkazù, které se na nìm vykonají.

\subsubsection*{Pøíklady:}
\small{
\begin{tabular}{lp{8 cm}}
	{\tt 1}        &  výbìr stánky 1\\
	{\tt 1..2}      & výbìr stránek 1 a¾ 2 (vèetnì 2) \\
	{\tt -1}	  &  výbìr poslední stránky ze seznamu\\
	{\tt -1..2}     & výbìr poslední a pøedposlední stránky,  \uv{od konce seznamu výbìr první a druhé}\\
	&\\
	{\tt foo(a)\{1..2 foo1\}} & pøíkaz {\tt foo} s parametrem {\it a} a selektorem {\it1..2}, na který se aplikuje pøíkaz {\tt foo1}\\
	foo\{1..2 -1..2\} & pøíkaz {\tt foo} bez parametru a selektory {\it 1..2} a {\it -1..2}\\
\end{tabular}
}
\vspace{5mm}

\subsubsection*{Syntaxe pøíkazu:}
\begin{center}
{\small \texttt{jméno(pevný\_parametr\_1,~\ldots, název\_parametru=hodnota,~\ldots)
   \{výbìr pøíkazy~\ldots\}}\}}
\end{center}

Program pou¾ívá kartézský souøadnicový systém s~poèátkem v~levém dolnímu rohu. 
Osa x je vodorovná orientovaná smìrem zleva doprava a osa y má orientaci 
svislou ze zdola na horu. Rozmìry papíru je mo¾né zadat názvem, v tom pøípadì se jedná o identifikátor, nebo explicitnì pomocí dvou èísel, ¹íøky a vý¹ky.
Název pøíkazù, u kterých se explicitnì zadává rozmìr papíru, konèí èíslovkou 2. Napøíklad k~pøíkazu {\it crop} existuje varianta {\it crop2}.

\subsection{Popis \uv{u¾iteèných pøíkazù}}
Asi mezi nejèastìj¹í pøedtiskovou úpravou dokumentu patøi \uv{transformace n stránek na jeden arch papíru}.
K tomu se hodí  pøíkaz nup.

\vspace{5mm}
\begin{tabular}{lp{10 cm}}
{\tt nup(2)}& otoèí stránku o~90 stupòù a pøerovná dvì stránky na jednu\\
{\tt nup(4)}&  pøeskládá ètyøi stránky na jednu bez rotace\\
{\tt nup(1,2,rotate=90)} & je ekvivalent pøíkazu nup(2), v x-ove ose 1 stránka (vodorovnì) a v y-ove ose 2 stránky (svisle)\\
{\tt nup(2,2,paper=a4)} & je ekvivalent pøíkazu nup(4), akorát výsledná stránka má formát a4\\
\end{tabular}
\vspace{5mm}

Dal¹í u¾iteèné parametry pøíkazu nup  jsou: frame (orámovaní), kde èíslo udává ¹íøku èáry, 
center (výchozí on výsledek je centrován, off nic se necentruje, final centruje se a¾ výsledná stránka),
dx, dy (minimalni ¹íøka mezi stránkami), orient (postup kladení stránek na stránku, portrait zleva doprava, z hora dolù, landscape zprava doleva z hora dolù).
Pokud není orient nastaven, bere se jako výchozí informace ze vstupního seznamu.
Velikost výsledné stránky se nezmìní, pokud není explicitnì uvedena.


Dal¹í u¾iteènou operací mù¾e být pøerovnání stránek pro tisk kní¾eèky.

\vspace{5mm}
\begin{tabular}{lp{10 cm}}
{\tt book} & pøerovná stránky pro tisk bookletu\\
{\tt book nup(2)} & nejprve pøerovná stránky pro tisk bookletu, pak umístí dvì stránky na jednu\\
\end{tabular}
\vspace{5mm}

Dále se mohou hodit následující operace.


\vspace{5mm}
\begin{tabular}{lp{10 cm}}
{\tt scaleto(a4)}&zvìt¹í/zmen¹í velikosti papíru na a4\\
{\tt scaleto2(1,2,3,4)}&zvìt¹í/zmen¹í velikosti papíru na explicitnì zadanou (levý dolní, pravý horní roh)\\
{\tt paper(a4)}&nastaví velikosti papíru na a4  (neprovádí se zvet¹eni, zmen¹eni stránky)\\
{\tt crop(a4)}&oøízne stránky na daný formát\\
{\tt crop2(1,2,3,4)}&oøízne stránky na daný rozmìr\\
{\tt merge}&	slouèí v¹echny stránky v seznamu na jednu\\
{\tt cmarks} &	 pøidá oøezové znaèky na stránku, jsou umístìny podle bboxu\\
\end{tabular}
\vspace{5mm}


Mezi zajímavé pøíkazy patøí modulo, select a apply.
Nejprve popi¹me modulo, první parametr n udává poèet stránek ve skupinách, na které se rozdìlí vstupní seznam. Pokud není celkový poèet stránek v~seznamu
násobkem èísla n, pøidá se na konec seznamu pøíslu¹ný poèet prázdných stránek, aby seznam mìl délku rovnu násobku èísla n. Pokud je nastaven parametr round, n je rovno  max(n,round).
Na ka¾dou skupinu je aplikován výbìr a provedou se pøíslu¹né pøíkazy. Pokud výbìr stránky obsahuje symbol '-' vybírají se stránky ze skupiny,
která je zrcadlovì symetrická dle støedu seznamu. Výsledná skupina seznamu je spojena do výstupního seznamu.
\subsubsection*{Pøíklad:}
Vezmeme seznam  stránek {\tt '1 2 3 4 5' }a aplikujeme na nìj modulo s $n$ rovným {\tt 3}. Nejprve se seznam doplní na vhodnou délku {\tt '1 2 3 4 5 6' }
a rozdìlí se na pøílslu¹né skupinky {\tt '1 2 3'} a {\tt '4 5 6'}. Vybereme {\tt \{1 -1\}} {\tt '1 6' a '4 3'} a výsledek spojíme {\tt '1 6 4 3'}.
Pokud parametr half je roven {\tt 1}, zpracovává se pouze polovina skupinek. V~tom pøípadì je výsledek pøedchozího pøíkladu {\tt '1 6'}.

\subsubsection*{Pøíklady:}
\vspace{5mm}
\begin{tabular}{lp{10 cm}}
 {\tt modulo(2,half=1)\{-1 1 2 -2\}} &	odpovídá operátoru book\\
{\tt modulo (1)\{-1\}} &obrátí seznam stránek\\
{\tt modulo(2)\{1 2 rotate(180)\}} &	odpovídá pøíkazu duplex(1), tj. první stránka bez zmìny, druhá se rotuje o 180 stupòù\\
{\tt modulo(16)\{1..16 book\}} & vytvoøení se signatura o 16-ti stránkách pro vázání kní¾ek\\
\end{tabular}
\vspace{5mm}

Pøíkaz apply provede na  vybraných stránkách zvolené pøíkazy. Pøíkaz select vybere stránky ze seznamu a pøípadnì na nì aplikuje pøíkazy.

\vspace{5mm}
\begin{tabular}{lp{10 cm}}
{\tt apply\{1 new \}} & za první stránku pøidá prázdnou\\
{\tt select\{1..10\}}	& vybere prvních deset stránek z dokumentu\\
\end{tabular}
\vspace{5mm}

Pokud potøebujeme docílit, aby v¹echny stránky v dokumentu mìly stejnou velikost, mù¾eme pou¾ít pøíkaz norm.
Mezi jeho argumenty patøí center, výchozí hodnota je centrovaní podle os x a y,  x centrovaní podle osy x, y centrovaní podle osy y, 
xy centrovaní podle obou os a none vypne centrovaní.

Nìkdy mají stránky zbyteènì velké okraje. V~tomto pøípadì je mo¾né nechat GhostScript pøepo\-èítat jejich okraje.
Tato operace se provádí pomocí pøíkazu bbox. Rozmìry výsledného bboxu je maximum z~bboxu jednotlivých stránek
ze seznamu.

\small{
\vspace{5mm}
\begin{tabular}{lp{9 cm}}
{\tt bbox scaleto(a4)} & pøepoèítá okraj a pøizpùsobí velikost stránek na papír a4\\
{\tt bbox norm(center=y) scale(a4)} & pøepoèítá okraje a pøizpùsobí velikosti stránek na papír a4,
vhodné pro stránky se zrcadlovì orientovanými okraji\\
\end{tabular}
\vspace{5mm}
}

V~jistých pøípadech se mù¾e hodit oèíslovat stránky, pro tento úkon je urèen pøíkaz number.\\

\vspace{5mm}
\begin{tabular}{lp{10 cm}}
{\tt numer} &	oèísluje v¹echny stránky, zaèíná se èíslem 1 a je umístìno dole na støedu stránky\\
{\tt number(10,10)} & obdobnì jako pøedchozí pøípad, jen èíslo je umístìno na pozici 10, 10 od levého dolního rohu\\
{\tt number(start=2)} & bude se èíslovat od 2\\
{\tt number(text="-\%d-")} & èíslovat se bude od 1, ale výstup bude vypadat následovnì "-èíslo\_stránky-" ("\%d" øíká, kde bude èíslo stránky)
\end{tabular}
\vspace{5mm}\\

Dal¹í parametry jsou: size (velikost písma), font (název øezu písma, font musí být obsa¾en v~pøíslu¹\-ném formátu).


\subsubsection{Seznam a struèný popis v¹ech pøíkazù}
\begin{longtable}{l|p{7.5 cm}}
{\tt apply\{page\_ranges\}}& aplikuje jednotlivé pøíkazy na výbìr stránek\\
{\tt bbox}&pøepoèítá na ka¾dé stránce bounding box za pomoci GhostScriptu\\
{\tt book}&	pøerovná stránky do kní¾eèky\\
{\tt cmarks(by\_bbox)}&pøidá na stránky oøezové znaèky, pokud je by\_box roven 0, pøidávají se dle rozmìru stránky, v opaèném pøípadì dle bounding boxu\\
{\tt crop(paper)}& oøízne stránku dle zadaných rozmìrù papíru\\
{\tt crop2(lx, ly, hx, hy)}&oøízne stránku dle zadaných rozmìrù\\
{\tt del}& sma¾e v¹echny stránky v~seznamu\\
{\tt duplex(long-edge)}&	pootáèí stránky v~seznamu pro duplexní tisk, parametr long-edge øíká, podle jaké strany papíru se bude otáèet (1 del¹í, 0 krat¹í)\\
{\tt flip(mode)}& zrcadlovì otoèí v¹echny stráneky v~seznamu, {\it horizontal{\tt |}h} vodorovnì, {\it vertical{\tt |}v} svisle. \\
{\tt line(b\_x, b\_y, e\_x, e\_y, size)}& nakreslí èáru ¹íøky {\it size} mezi body {\it b\_x, b\_y} a { \it e\_x, e\_y} \\
{\tt matrix(a,b,c,d,e,f)}& provede afinní transformaci souøadnic stránky dle zadané matice\\
{\tt merge}& spojí stránky v~seznamu do jedné (polo¾í je pøes sebe)\\
{\tt modulo(pages, half, round)\{page\_ranges\}}&\\
{\tt move(x, y)}& posune obsah stránky o~{\it x, y}\\
{\tt new\{pøíkazy\}}& vytvoøí a pøidá prázdnou stránku na konec seznamu a aplikuje na  ní {\it pøíkazy}\\
{\tt norm(center, scale, l\_bbox, g\_bbox)} & normování velikosti stránek v~seznamu\\
{\tt number(start, font\_size, font)}& pøidá  na jednotlivé stránky èísla stránek, {\it start}  
poèátek èíslování, {\it font}  jméno fontu {\it øetìzec}, text, který se má na stránku vykreslit, výchozí \uv{\%d} èíslo stránky,  {\it font\_size} velikost písma, v¹echny parametry jsou nepovinné\\
{\tt nup(x, y, dx, dy, orientation, frames)}& pøeskládá $x\cdot y$ stránek na jednu, {\it x} poèet stránek ve vodorovném smìru,
{\it y} poèet stránek ve svislém smìru, {\it dx} mezera mezi stránkami ve vodorovném smìru, {\it dy} mezera mezi stránkami ve svislém smìru, {\it orientation} zpùsob rovnání stránek,
{\it frames} stránky budou orámovány\\
{\tt orient(landscape{\tt |}portrait)}&  nastaví orientaci textu na stránkách v~seznamu\\
{\tt paper(paper\_size)}& nastaví velikost papíru stránkám v~seznamu, neprovede se ¾ádná zmìna mìøítka\\
{\tt paper2(x, y)}& nastaví explicitní rozmìry papíru\\
{\tt read(name)} & pøipojí na konec seznamu  stránky ze souboru {\it name}, {\it name} je øetìzec\\
{\tt rotate(angle)}& otoèí stránky o~úhel {\it angle} ve stupních\\
{\tt scale(scale)} &	zmìní velikost stránek v zadaném mìøítku $scale<1$ zmen¹ení, $scale>1$ zvìt¹ení\\
{\tt scaleto(paper, top, right, bottom, left)} &zmìní velikost v¹ech stránek v~seznamu, {\it paper\_size} je velikost papíru, na kterou se stránka pøetransformuje, okraje jsou explicitnì nastaveny na pùl palce\\
{\tt scaleto2(x, y, top, right, bottom, left)} &zmìní velikost v¹ech stránek v~seznamu na explicitní velikost papíru, provádí se zmìna mìøítka\\
{\tt select\{page\_ranges\}}& vybere stránky dle {\it page\_ranges}, aplikuje  na nì pøíslu¹né pøíkazy, výsledný seznam obsahuje pouze stránky z~výbìru\\
{\tt text(x, y, text, size, font)}& nakreslí text na v¹echny stránky v~seznamu,{ \it  x,y} umístìní na stránce, { \it size} velikost fontu, { \it font} jméno fontu, parametry { \it size} a { \it font} jsou nepovinné\\
{\tt write(name)}& ulo¾í seznam stránek do souboru {\it name}, {\it name} je øetìzec \\
\end{longtable}

\subsubsection*{Omezení}
Soubory ve formátu PostScript nelze spojovat dohromady a jsou u nich vy¾adovány DSC komentáøe.
V pøípadì PDF formátu nelze pracovat s kryptovanými PDF. Dále neumí program pracovat s~dokumentem PDF,
který vyu¾ívá nìkterá roz¹íøení z~verze 1.5 a novìj¹ích.
Mezi nì patøí napøíklad ObjectStreams a Cross-Reference Streams.

\subsubsection*{Instalace}
\begin{enumerate} 
\item stáhnout ze svn zdrojové kódy,\\
{\tt "svn co https://pspdftool.svn.sourceforge.net/svnroot/pspdftool pspdftool"}\\
nebo pou¾ít balíèek se zdrojovými kódy a rozbalit jej\\
{\tt "tar xvzf pspdftool"}
\item pøepnout se do adresáøe se zdrojovými kódy\\
{\tt  "cd pdpdftool/trunk"}
\item konfigurace pøeklad a instalace\\
{\tt "./configure \&\& make \&\& make install"}
\end{enumerate} 


Program funguje pod Linuxem a Mac OS X. Mìl by pøenosný i na ostatní UNIXové systémy, na kterých nebyl testován.  Potøebuje ke své èinnosti zlib a GhostScript.

\chapter{Pspdftool - implemntace}

\section{Zobecnìní dokumentu}
Dokument urèený pro tisk obsahuje informace o~stránkách a jejich vlastnostech. Pro reprezentaci stránek jsem zvolil spojový seznam. Jeho prvky odpovídají jednotlivým stránkám v~dokumentu.
Se seznamem lze jednodu¹e provádìt následující operace: zmìny poøadí, duplikace, smazání a pøeuspoøádání stránek.
Pro ka¾dou stránku v~seznamu je ulo¾ena informace o~rozmìru papíru, velikosti bounding boxu, orientaci textu a èást implementaènì závislou na konkrétním formátu.
Hlava seznamu obsahuje globální informace platné pro v¹echny stránky: maximální bbox, maximální velikost papíru, globální orientaci textu na stránce a implementaènì závislou èást na konkrétním formátu.

 Knihovnu jsem rozdìlil na dvì èásti, èást nezávislou na konkrétním formátu a èást implementující konkrétní formát. Výhodou tohoto návrhu je snadná roz¹íøitelnost o~dal¹í formát.
 Èást nezávislá na formátu implementuje libovolné operace se seznamem, jako jsou pøeuspoøádání stránek, výbìr stránek a podobnì.

 Èást závislá na formátu implementuje následující funkce: naètení dokumentu, ulo¾ení dokumentu, spojení dvou dokumentù, transformaci jednotlivé stránky, spojení dvou stránek do jedné, kreslení a psaní textu na stránku, oøez stránky.
 Zámìrem bylo navrhnout rozhraní mezi èástí závislou a èástí nezávislou na formátu co mo¾ná nejjednodu¹¹í. Napøíklad rotace nebo zmìna velikosti stránky se provede aplikací vhodné transformaèní matice na stránku.

Obecnì nemusí být jednoduché implementovat v¹echny operace s~konkrétním formátem (napø. nelze jednodu¹e spojit dva rùzné PostScriptové soubory).
Pro tento pøípad jsem implementoval formát {\it dummydoc}, jeho¾ interface je zavolán v~pøípadì absence urèité funkce konkrétního formátu. Ve vìt¹inì pøípadù skonèí toto volání chybou.

\section{Èást nezávislá na konkrétním formátu}
Tato èást knihovny obsahuje èásti nezávislé na konkrétním formátu. Patøí sem interface pro práci a registraci konkrétních formátù, sada funkcí pro práci s~transformaèní maticí, funkce pro práci se seznamem stránek a dal¹í pomocné funkce. 
Do této èásti mù¾eme øadit pøíkazový interpret, který popí¹i pozdìji.

\section{Implementace konkrétních formátù}
Pro ovìøení návrhu knihovny jsem implementoval následující formáty PostScript a PDF. Tato implementace je také ukázkou, jak by se mohly pøidávat dal¹í formáty.

Ka¾dý formát musí obsahovat funkci, která je pøedána funkci {\it doc\_register\_format} pro pøidání nového formátu do pspdftoolu. Pøi registraci formátu je této  funkci pøedána struktura definující interface mezi závislou a nezávislou  èástí na formátu.
Funkce naplní ve struktuøe ukazatele na rutiny pro práci s~novým formátem. Struktura obsahuje jednoznaènou tøípísmennou identifikaci formátu (z~pravidla koncovka dokumentu).

\subsection{PostScript}
Od~PostScriptového souboru po¾adujeme, aby obsahoval DSC komentáøe. Bez nich nejsme schopni urèit, ani¾ by bylo potøeba PostScript interpretovat,
kde zaèíná a konèí pøíslu¹ná stránka dokumentu. PostScriptové soubory, jak bylo uvedeno vý¹e, nelze jednodu¹e spojovat dohromady.

Nástroj PSUtils umo¾òuje spojovat pouze soubory se stejným prologem. Moje implementace pro PS formát neumo¾òuje spojovat ¾ádné  dokumenty.

Funkce pro naètení dokumentu funguje následovnì: vstupní soubor se ète po øádcích a zpracovávají se øádky s~DSC komentáøem. Za pomoci tìchto komentáøù lze
soubor rozdìlit na následující èásti: hlavièku, procdef, docsetup, jednotlivé stránky a trailer. Ka¾dá èást má nìjaký význam, viz. kapitola o DSC komentáøích.

U~stránky si pamatuji její offset v~souboru. Proto¾e PS soubor mù¾e být velmi veliký (stovky MB), nemapuji ho celý do pamìti.

Do sekce procdef se pøidají vlastní definice a redefinice PostScriptových operátorù potøebných pro práci knihovny.
Napøíklad zmìna operátoru {\it showpage} na prázdný a místo nìj definice nového.

Samotné operace typu transformace, kreslení èar, psaní textu; jsou uskuteènìny pøidáním pøíslu¹\-ných PS operátorù a jejich argumentù na zaèátek  \uv{programu} stránky.

Spojení dvou stránek se provede spojením obsahù stránek, mezi jednotlivé stránky je vhodné pøidat operátory pro ulo¾ení a 
obnovení grafického stavu interpretu PostScriptu. Na konec jednotlivých stránek se pøidá novì definovaný operátor pro zobrazení stránky.


\subsection{PDF}
U~PDF dokumentu je mo¾né implementovat v¹echny operace. V~dokumentu se pøeètou v¹echny objekty. Objekty stránek se pøevedou na objekty XObject. K~pùvodní stránce se vytvoøí nová stránka, která obsahuje XObject z~pùvodní stránky. U~ka¾dé stránky v~seznamu si pamatuji pøíslu¹né èíslo objektu, který ji reprezentuje. Pøi ukládání dokumentu se vygeneruje ze seznamu stránek
strom stránek (dle specifikace PDF), odstraní se nepou¾ité objekty (prohledáním do hloubky od Catalog objektu).  Do souboru se zapí¹í v¹echny pou¾ité objekty a na konec se pøidá trailer a tabulka referencí.

Operace typu transformace, spojení dvou stránek do jedné, kreslení èar a psaní textu se týkají streamu pøíslu¹né stránky. Proto¾e jsme si vytvoøili z~pùvodních stránek XObjecty a nové stránky, které se na nì odkazují, mají stream v~nezakódované podobì. Není tedy potøeba implementovat jednotlivé filtry pro práci se streamem. Spojení dvou stránek odpovídá spojení dvou Content Streamù za sebe. Kreslení a transformace  odpovídá pøidání pøíslu¹ných operátorù do Content Streamu stránky.
Druhou výhodou daného øe¹ení je jednoduché slouèení resources stránky.

Problém nastane, pokud chceme zkonvertovat stránku, její¾ popis je rozdìlen do více streamù. Pøímoèaré øe¹ení by bylo zkonvertovat ka¾dou èást na XObject.
Vzhledem k tomu, ¾e mohou být streamy mezi sebou závislé, nemusí být tento pøevod korektní ve v¹ech pøípadech. Tento problém lze vyøe¹it pouze
slouèením více streamù do jednoho. Pro tento úkon je potøeba stream dekryptovat. Proto jsem doplnil do programu funkce pro dekompresi streamu v LZW a deflate.
Pokud nebude k~dispozici filtr pro práci se streamem, program vygeneruje varovaní a pou¾ije vý¹e citovaný nekorektní postup. Filtry jsou implementovány v~souboru {\it pdf\_filters}.c.

Pro operaci spojení dvou dokumentù je potøeba v~jednom z~dokumentù pøeèíslovat objekty tak, aby nekolidovaly s~druhým dokumentem. V~pspdftoolu je pou¾ito následující
øe¹ení: v~pøipojovaném dokumentu se pøiète ke ka¾dému èíslu objektu èíslo udávající poèet objektù v~druhém souboru. 

Implementace formátu plnì podporuje PDF do verze 1.4. Novìj¹í PDF obsahují napøíklad tato roz¹íøení: ObjectStreams a Cross-Reference Streams. 
Proto¾e tato roz¹íøení nejsou èasto vyu¾ívána, nepova¾oval jsem za dùle¾ité, aby s~nimi umìl nástroj pracovat.
K~jejich implementaci by bylo vhodné umìt pracovat se v¹emi filtry, které jsou definovány ve specifikaci PDF.
	
\section{Interpret pøíkazù}
V~souèasné dobì je k~dané knihovnì napsán jediný u¾ivatelský agent, jednoduchý interpret pøíkazù.
Jeho implementace se nachází v~souboru {\tt cmdexec.c}. Tokenizér {\it cmd\_get\_token} rozkládá vstupní soubor na tokeny. 
Tokenizér je volán funkcí {\it cmd\_make\_tree}, jednoduchý LR1 parser, který z~tokenù vytvoøí derivaèní strom.
Na výsledný derivaèní strom je zavolána funkce   {\it cmd\_exec\_tree}, která vykoná zadané pøíkazy.
Funkce {\it cmd\_exec} provede zadané pøíkazy na seznam stránek.
Pøíkazy, které interpret obsahuje, jsou definovány ve struktuøe {\it cmd\_commands}.
První polo¾kou je název pøíkazu, druhou jeho nápovìda,  tøetí ukazatel na obslu¾nou funkci a poslední argumenty pøíkazu.
Ka¾dé obslu¾né funkci je pøedán seznam stránek, pole argumentù funkce a selektor stránek \footnote{ viz syntaxe pøíkazu}.

\chapter{Závìr}
V~této práci jsem prozkoumal mo¾nosti pøedtiskových úprav dokumentù. 
Vytvoøil jsem  vlastní nástroj, který je komplexnìj¹í ne¾ øe¹ení  souèasná.
Mezi jeho hlavní výhody patøí: stejné rozhraní pro více formátù, mo¾nost
ho roz¹íøit o~dal¹í formáty, pøípadnì konverze jednoho formátu na druhý s~u¾itím
externího programu.

Na tisku by se dalo zkoumat mnohé, napøíklad: techniky tisku,
barevné kalibrace zaøízení, nebo nástroje pro tvorbu dokumentù.

Mnou vytvoøený nástroj pspdftool není primárnì urèen k~profesionálnímu pou¾ití v~tiskár\-nách.
Neumí napøíklad pracovat s barvami, nebo pøidat soutiskové znaèky. 
Dle mého názoru absence tìchto operací není omezující pøi tisku èernobílých dokumentù.
Zpravidla se v~profesionálním prostøedí vytváøí dokument pro tisk pøesnì 
na míru, tj. není na nìj potøeba aplikovat pøedtiskové úpravy.

Vhodné by bylo doplnit k~nástroji grafické rozhraní pro jeho intuitivnìj¹í ovládání.
Pøíkazový interpret by se mohl roz¹íøit o definici u¾ivatelských maker.
Èást pracující s~PDF by mohla být roz¹íøena o~dal¹í filtry a o dal¹í roz¹íøení
novìj¹ích verzí PDF. Do èásti implementující práci s PostScriptem by bylo vhodné
doplnit operace, které by napøíklad tiskárnì øekly, jestli má pou¾ívat duplex.
Bylo by mo¾nì pøidat do programu knihovny pro práci s~ostatními formáty, napøíklad
PCL nebo GDI.
Dal¹í roz¹íøení této funkcionality by mohlo být zpracování PPD konkrétní tiskárny
a na základì informací z PPD zapnout, nebo vypnout urèitou pøedvolbu tisku.

%%% Seznam literatury
%%%
%%% Literatura se øadí abecednì. Úvádí se pouze literatura, na kterou se v~textu odkazuje.
%%% Pøi odkazu na knihu se v¾dy uvádìjí èísla stránek.



\begin{thebibliography}{99}
\addcontentsline{toc}{chapter}{Literatura}
 \bibitem{postscript}Adobe Systems, Inc., {\em PostScript Language Reference Manual}, 3rd edition, Addison-Wesley Professional,1999.
 \bibitem{pdf}Adobe Systems, Inc., {\em PDF reference Version 1.6, 5th edition}, Adobe Press 2004.
 \bibitem{dsc}Adobe Systems, Inc., {\em PostScript Language  Document Structuring Conventions Specification}, Adobe Press 1992.
\bibitem{ghostscript} http://www.ghostscript.com/awki
\bibitem{psutils} http://www.tardis.ed.ac.uk/\textasciitilde{}ajcd/psutils/
\bibitem{pdftk} http://www.accesspdf.com/pdftk/index.html
\end{thebibliography}

\appendix \chapter{Obsah pøilo¾eného CD-ROM}
Na pøilo¾eném CD-ROMu se nachází v~adresáøi {\it bc\_text} zdrojové kódy a text bakaláøské práce, v~adresáøi {\it src} se nachází zdrojový kód programu.

\end{document}




